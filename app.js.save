require("dotenv").config();

const { Telegraf } = require('telegraf');
const bot = new Telegraf(process.env.token);
const feedUrl = "https://www.iisvaldagno.it/feed/";
const fs = require("fs");

let Parser = require('rss-parser');
const { brotliCompress } = require("zlib");
let parser = new Parser();

bot.start(() => {
  console.log('Servizio avviato!');
});

/etc/systemd/system/pm2-root.servicelet blacklistedNews = [];
blacklistAll();


function blacklistAll() {
  parser.parseURL('https://www.iisvaldagno.it/feed/').then(feed => {
    feed.items.forEach(item => {
      blacklistedNews.push(item.link);
    });
  }).then(() => {
    checkForNews();
  });
}

function checkForNews() {
  parser.parseURL('https://www.iisvaldagno.it/feed/').then(feed => {
    let news = [];
    feed.items.forEach(item => {
      if (!blacklistedNews.includes(item.link)) {
        news.push({
          title: item.title,
          link: item.link,
          isoDate: item.isoDate,
          contentSnippet: item.contentSnippet,
          categories: item.categories
        });

        ///bot.context.telegram.getChat("-1001160865248");
        bot.telegram.sendMessage("-1001160865248", `${item.title}\n${item.contentSnippet}\n\n${item.link}`);

        blacklistedNews.push(item.link);
      }
    });

    if(news.length > 0)
      console.log(news[news.length - 1].title);

    news.forEach(ns => {
      fs.appendFile('links.txt', `${ns.title}\n`, function (err) {
        if (err) throw err;
      });
    });
  });

  setTimeout(checkForNews, 10000)
}

bot.launch();
